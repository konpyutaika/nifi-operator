<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://konpyutaika.github.io/nifikop/blog</id>
    <title>NiFiKop Blog</title>
    <updated>2020-06-30T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://konpyutaika.github.io/nifikop/blog"/>
    <subtitle>NiFiKop Blog</subtitle>
    <icon>https://konpyutaika.github.io/nifikop/img/nifikop.ico</icon>
    <rights>Copyright © 2025 Konpyūtāika, Inc. Built with Docusaurus.</rights>
    <entry>
        <title type="html"><![CDATA[Secured NiFi cluster with NiFiKop with external dns on the Google Cloud Platform]]></title>
        <id>https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns</id>
        <link href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns"/>
        <updated>2020-06-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Objectives]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_JmGV" id="objectives">Objectives<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#objectives" class="hash-link" aria-label="Direct link to Objectives" title="Direct link to Objectives">​</a></h2>
<p>This article is pretty similar to the <a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp">Secured NiFi cluster with NiFiKop on the Google Cloud Platform</a> one.</p>
<p>This time, we will also use <strong>NiFiKop</strong> and <strong>Terraform</strong> to quickly:</p>
<ul>
<li>deploy <strong>a GKE cluster</strong> to host our NiFi cluster,</li>
<li>deploy <strong>a <code>cert-manager</code> issuer</strong> as a convenient way to generate TLS certificates,</li>
<li>deploy <strong>a zookeeper instance</strong> to manage cluster coordination and state across the cluster,</li>
<li>deploy <strong>X secured NiFi instances in cluster mode</strong></li>
<li>configure <strong>NiFi to use OpenId connect</strong> for authentication</li>
<li>configure <strong>HTTPS loadbalancer with Client Ip affinity</strong> to access the NiFi cluster</li>
<li>dynamically re-size the cluster</li>
</ul>
<p>We will:</p>
<ul>
<li>deploy <a href="https://github.com/kubernetes-sigs/external-dns" target="_blank" rel="noopener noreferrer">external DNS</a> instead of manually declare our DNS names.</li>
<li>delegate the certificates authority to <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">Let's Encrypt</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="pre-requisites">Pre-requisites<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#pre-requisites" class="hash-link" aria-label="Direct link to Pre-requisites" title="Direct link to Pre-requisites">​</a></h2>
<ul>
<li>You have your own domain (<a href="https://domains.google/" target="_blank" rel="noopener noreferrer">you can create one with Google</a>): it will be used to map a domain on the NiFi's web interface. In this post, we will use: <code>trycatchlearn.fr</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer">Disclaimer<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h3>
<p>This article can get you started for a production deployment, but should not used as so. There are still some steps needed such as Zookeeper, GKE configuration etc.</p>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="create-oauth-credentials">Create OAuth Credentials<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#create-oauth-credentials" class="hash-link" aria-label="Direct link to Create OAuth Credentials" title="Direct link to Create OAuth Credentials">​</a></h3>
<p>First step is to create the OAuth Credential:</p>
<ul>
<li>Go to your GCP project, and in the left bar: <strong>APIs &amp; Services &gt; Credentials</strong></li>
<li>Click on <code>CREATE CREDENTIALS: OAuth client ID</code></li>
<li>Select <code>Web Application</code></li>
<li>Give a name such as <code>SecuredNifi</code>.</li>
<li>For <code>Authorised JavaScript origins</code>, use your own domain. I'm using: <code>https://nifi.orange.trycatchlearn.fr:8443</code></li>
<li>For <code>Authorised redirect URIs</code> it's your previous URI + <code>/nifi-api/access/oidc/callback</code>, for me: <code>https://nifi.orange.trycatchlearn.fr:8443/nifi-api/access/oidc/callback</code></li>
</ul>
<p><img decoding="async" loading="lazy" alt="OAuth credentials" src="https://konpyutaika.github.io/nifikop/assets/images/oauth_credentials-531aa57e08dcc1e4a0a0bace39d779c3.png" width="695" height="820" class="img_SS3x"></p>
<ul>
<li>Create the OAuth credentials</li>
</ul>
<p>Once the credentials are created, you will get a client ID and a client secret that you will need in <code>NifiCluster</code> definition.</p>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="create-service-account">Create service account<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#create-service-account" class="hash-link" aria-label="Direct link to Create service account" title="Direct link to Create service account">​</a></h3>
<p>For the GKE cluster deployment you need a service account with <code>Editor</code> role, and <code>Kubernetes Engine Admin</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-secured-cluster">Deploy secured cluster<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#deploy-secured-cluster" class="hash-link" aria-label="Direct link to Deploy secured cluster" title="Direct link to Deploy secured cluster">​</a></h2>
<p>Once you have completed the above prerequisites, deploying you NiFi cluster will only take three steps and few minutes.</p>
<p>Open your Google Cloud Console in your GCP project and run:</p>
<div class="language-sh codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sh codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">git clone https://github.com/Okonpyutaika/nifikop.git</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cd nifikop/docs/tutorials/secured_nifi_cluster_on_gcp_with_external_dns</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-gke-cluster-with-terraform">Deploy GKE cluster with Terraform<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#deploy-gke-cluster-with-terraform" class="hash-link" aria-label="Direct link to Deploy GKE cluster with Terraform" title="Direct link to Deploy GKE cluster with Terraform">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_JmGV" id="deployment">Deployment<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">​</a></h4>
<p>You can configure variables before running the deployment in the file <code>terraform/env/demo.tfvars</code>:</p>
<ul>
<li><strong>project</strong>: GCP project ID</li>
<li><strong>region</strong>: GCP region</li>
<li><strong>zone</strong>: GCP zone</li>
<li><strong>cluster_machines_types</strong>: defines the machine type for GKE cluster nodes</li>
<li><strong>min_node</strong>: minimum number of nodes in the NodePool. Must be &gt;=0 and &lt;= max_node_count.</li>
<li><strong>max_node</strong>: maximum number of nodes in the NodePool. Must be &gt;= min_node_count.</li>
<li><strong>initial_node_count</strong>: the number of nodes to create in this cluster's default node pool.</li>
<li><strong>preemptible</strong>: true/false using preemptibles nodes.</li>
</ul>
<div class="language-sh codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sh codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">cd terraform</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">./start.sh &lt;service account key's path&gt;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This operation could take 15 minutes (time to the GKE cluster and its nodes to setup)</p>
<p>Once the deployment is ready load the GKE configuration:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">gcloud container clusters get-credentials nifi-cluster --zone &lt;configured gcp zone&gt; --project &lt;GCP project's id&gt;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_JmGV" id="explanations">Explanations<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#explanations" class="hash-link" aria-label="Direct link to Explanations" title="Direct link to Explanations">​</a></h4>
<p>The first step is to deploy a GKE cluster, with the required configuration, you can for example check the nodes configuration:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get nodes</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                                                  STATUS   ROLES    AGE    VERSION</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-2dl3   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-5bzb   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-5t3l   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-w86j   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the cluster is deployed, we created all the required namespaces:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get namespaces</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME              STATUS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager      Active   16m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">default           Active   27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kube-node-lease   Active   27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kube-public       Active   27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kube-system       Active   27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifikop           Active   16m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper         Active   16m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the <code>cert-manager</code> namespace we deployed a <code>cert-manager</code> stack in a cluster-wide scope, which will be responsible for all the certificates generation.</p>
<div class="theme-admonition theme-admonition-note admonition_WCGJ alert alert--secondary"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_pbrs"><p>in this post, we will let <code>let's encrypt</code> act as certificate authority.
For more informations check <a href="https://konpyutaika.github.io/nifikop/docs/3_manage_nifi/1_manage_clusters/1_deploy_cluster/4_ssl_configuration#using-an-existing-issuer">documentation page</a></p></div></div>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl -n cert-manager get pods</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                                       READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager-55fff7f85f-74nf5              1/1     Running   0          72m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager-cainjector-54c4796c5d-mfbbx   1/1     Running   0          72m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager-webhook-77ccf5c8b4-m6ws4      1/1     Running   2          72m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It will also deploy the Zookeeper cluster based on the <a href="https://github.com/bitnami/charts/tree/master/bitnami/zookeeper" target="_blank" rel="noopener noreferrer">bitnami helm chart</a>:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl -n zookeeper get pods</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME          READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper-0   1/1     Running   0          74m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper-1   1/1     Running   0          74m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper-2   1/1     Running   0          74m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And finally it deploys the <code>NiFiKop</code> operator which is ready to create NiFi clusters:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl -n nifikop get pods</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">external-dns-5d588c6cd6-dw44f   1/1     Running   0          2m58s</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-nifikop">Deploy NiFiKop<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#deploy-nifikop" class="hash-link" aria-label="Direct link to Deploy NiFiKop" title="Direct link to Deploy NiFiKop">​</a></h3>
<p>Now we have to deploy the <code>NiFiKop</code> operator:</p>
<p>Deploy the NiFiKop crds:</p>
<div class="tabs-container tabList_J5MA"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_l0OV tabs__item--active">k8s version 1.16+</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_l0OV">k8s previous versions</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_wHwb"><div class="language-bash codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-bash codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Orange-OpenSource/nifikop/master/deploy/crds/nifi.orange.com_nificlusters_crd.yaml</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Orange-OpenSource/nifikop/master/deploy/crds/nifi.orange.com_nifiusers_crd.yaml</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_wHwb" hidden=""><div class="language-bash codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-bash codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Orange-OpenSource/nifikop/master/deploy/crds/v1beta1/nifi.orange.com_nificlusters_crd.yaml</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl apply -f https://raw.githubusercontent.com/Orange-OpenSource/nifikop/master/deploy/crds/v1beta1/nifi.orange.com_nifiusers_crd.yaml</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<div class="language-bash codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-bash codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">helm repo add orange-incubator https://orange-kubernetes-charts-incubator.storage.googleapis.com/</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">helm repo update</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="tabs-container tabList_J5MA"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_l0OV tabs__item--active">helm 3</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_l0OV">helm previous</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_wHwb"><div class="language-bash codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-bash codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain"># You have to create the namespace before executing following command</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">helm install nifikop \</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    --namespace=nifikop \</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    --set image.tag=v0.2.1-release \</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    orange-incubator/nifikop</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_wHwb" hidden=""><div class="language-bash codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-bash codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">helm install --name=nifikop \</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    --namespace=nifikop \</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    --set image.tag=v0.2.1-release \</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    orange-incubator/nifikop</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-lets-encrypt-issuer">Deploy Let's encrypt issuer<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#deploy-lets-encrypt-issuer" class="hash-link" aria-label="Direct link to Deploy Let's encrypt issuer" title="Direct link to Deploy Let's encrypt issuer">​</a></h3>
<p>As mentioned at the start of the article, we want to delegate the certificate authority to <a href="https://letsencrypt.org/" target="_blank" rel="noopener noreferrer">Let's Encrypt</a>, so to do this with <code>cert-manager</code> we have to create an issuer.
So edit the <code>kubernetes/nifi/letsencryptissuer.yaml</code> and set it with your own values:</p>
<div class="language-yaml codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-yaml codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token key atrule" style="color:#859900">apiVersion</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">manager.io/v1alpha2</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">kind</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> Issuer</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">metadata</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">name</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> letsencrypt</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">staging</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">spec</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">acme</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1"># You must replace this email address with your own.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1"># Let's Encrypt will use this to contact you about expiring</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1"># certificates, and issues related to your account.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">email</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> &lt;your email</span><span class="token punctuation" style="color:#657b83">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">server</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain">//acme</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">staging</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">v02.api.letsencrypt.org/directory</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">privateKeySecretRef</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token comment" style="color:#93a1a1"># Secret resource used to store the account's private key.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">name</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> example</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">issuer</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">account</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">key</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1"># Add a single challenge solver, HTTP01 using nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">solvers</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#859900">http01</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">          </span><span class="token key atrule" style="color:#859900">ingress</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">            </span><span class="token key atrule" style="color:#859900">ingressTemplate</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">              </span><span class="token key atrule" style="color:#859900">metadata</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">                </span><span class="token key atrule" style="color:#859900">annotations</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">                  </span><span class="token key atrule" style="color:#859900">"external-dns.alpha.kubernetes.io/ttl"</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"5"</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You just have to change the <code>Spec.Acme.Email</code> field with your own email.
You can also change the acme server to prod one <code>https://acme-v02.api.letsencrypt.org/directory</code></p>
<p>Once the configuration is ok, you can deploy the <code>Issuer</code>:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">cd ..</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl create -f kubernetes/nifi/letsencryptissuer.yaml</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-secured-nifi-cluster">Deploy Secured NiFi cluster<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#deploy-secured-nifi-cluster" class="hash-link" aria-label="Direct link to Deploy Secured NiFi cluster" title="Direct link to Deploy Secured NiFi cluster">​</a></h3>
<p>You will now deploy your secured cluster to do so edit the <code>kubernetes/nifi/secured_nifi_cluster.yaml</code> and set with your own values:</p>
<div class="language-yaml codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-yaml codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token key atrule" style="color:#859900">apiVersion</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> nifi.orange.com/v1alpha1</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">kind</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> NifiCluster</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">metadata</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">name</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> securednificluster</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">namespace</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> nifi</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">spec</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">initialAdminUser</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> &lt;your google account email</span><span class="token punctuation" style="color:#657b83">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">readOnlyConfig</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1"># NifiProperties configuration that will be applied to the node.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">nifiProperties</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">webProxyHosts</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">        </span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain"> &lt;nifi's hostname</span><span class="token punctuation" style="color:#657b83">&gt;</span><span class="token punctuation" style="color:#657b83">:</span><span class="token number" style="color:#5a9bcf">8443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token comment" style="color:#93a1a1"># Additionnal nifi.properties configuration that will override the one produced based</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token comment" style="color:#93a1a1"># on template and configurations.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">overrideConfigs</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">|</span><span class="token scalar string" style="color:#8dc891"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        ...</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        nifi.security.user.oidc.client.id=&lt;oidc client's id&gt;</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        nifi.security.user.oidc.client.secret=&lt;oidc client's secret&gt;</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token punctuation" style="color:#657b83">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">listenersConfig</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">useExternalDNS</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#cb4b16;font-weight:bold">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">clusterDomain</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> &lt;nifi's domain name</span><span class="token punctuation" style="color:#657b83">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">sslSecrets</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">tlsSecretName</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> </span><span class="token string" style="color:#8dc891">"test-nifikop"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">create</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#cb4b16;font-weight:bold">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">issuerRef</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">        </span><span class="token key atrule" style="color:#859900">name</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> letsencrypt</span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain">staging</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">        </span><span class="token key atrule" style="color:#859900">kind</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> Issuer</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>
<p><strong>Spec.InitialAdminUser</strong>: Your GCP account email (this will give you the admin role into the NiFi cluster), in my case <code>alexandre.guitton@orange.com</code></p>
</li>
<li>
<p><strong>Spec.ReadOnlyConfig.NifiProperties.WebProxyHosts[0]</strong>: The web hostname configured in the Oauth section, in my case <code>nifi.orange.trycatchlearn.fr</code></p>
</li>
<li>
<p><strong>Spec.ReadOnlyConfig.NifiProperties.OverrideConfigs</strong>: you have to set the following properties:</p>
<ul>
<li><em>nifi.security.user.oidc.client.id</em>: OAuth Client ID</li>
<li><em>nifi.security.user.oidc.client.secret</em>: OAuth Client secret</li>
</ul>
</li>
<li>
<p><strong>Spec.ListenersConfig.ClusterDomain</strong>: This the domain name you configure into your <code>External DNS</code> and <code>Cloud DNS</code> zone. In my case <code>orange.trycatchlearn.fr</code></p>
</li>
</ul>
<p>Once the configuration is ok, you can deploy the <code>NifiCluster</code>:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl create -f kubernetes/nifi/secured_nifi_cluster.yaml</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first time can take some time, the <code>cert-manager</code> and <code>Let's encrypt</code> will check that you are able to manage the dns zone, so if you check the pods:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get pods -n nifikop</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-4fg5b       1/1     Running   0          18s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-6sw9x       1/1     Running   0          20s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-bpzvm       1/1     Running   0          20s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-f8xvs       1/1     Running   0          19s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-k997c       1/1     Running   0          17s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-l5fzz       1/1     Running   0          18s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">external-dns-569bf79b57-hjmtt   1/1     Running   0          9h</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifikop-56cb587d96-p8vdf        1/1     Running   0          29s</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And check the ingresses:</p>
<div class="language-bash codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-bash codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get ingresses -n nifikop</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                        HOSTS                                                 ADDRESS          PORTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-4pff9   nifi-2-node.nifi-headless.orange.trycatchlearn.fr                      80      2m27s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-cfsf4   nifi-0-node.nifi-headless.orange.trycatchlearn.fr     34.120.24.109    80      2m30s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-hn8jj   nifi-controller.nifikop.mgt.orange.trycatchlearn.fr   34.120.90.24     80      2m29s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-llhsp   nifi-1-node.nifi-headless.orange.trycatchlearn.fr                      80      2m27s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-v8dmm   nifi-headless.orange.trycatchlearn.fr                 34.120.201.215   80      2m28s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cm-acme-http-solver-xvs9f   nifi.orange.trycatchlearn.fr                          35.244.202.176   80      2m27s</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see some ngnix instances that are used to validate all the dns names you required into your certificates (for nodes and services).</p>
<p>After some times your cluster should be running:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get pods -n nifikop</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">external-dns-569bf79b57-hjmtt   1/1     Running   0          9h</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifi-0-nodekmhgz                1/1     Running   0          27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifi-1-node4465q                1/1     Running   0          27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifi-2-node5jwwx                1/1     Running   0          27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifikop-56cb587d96-p8vdf        1/1     Running   0          40m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="access-to-your-secured-nifi-cluster">Access to your secured NiFi Cluster<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#access-to-your-secured-nifi-cluster" class="hash-link" aria-label="Direct link to Access to your secured NiFi Cluster" title="Direct link to Access to your secured NiFi Cluster">​</a></h3>
<p>You can now access the NiFi cluster using the loadbalancer service hostname <code>&lt;nifi's cluster name&gt;.&lt;DNS name&gt;</code>, in my case it's <a href="https://nifi.orange.trycatchlearn.fr:8443/nifi" target="_blank" rel="noopener noreferrer">https://nifi.orange.trycatchlearn.fr:8443/nifi</a> and authenticate on the cluster using the admin account email address configured in the <code>NifiCluster</code> resource.</p>
<p>Here is my 3-nodes secured NiFi cluster up and running:</p>
<p><img decoding="async" loading="lazy" alt="3 nodes cluster" src="https://konpyutaika.github.io/nifikop/assets/images/3_nodes_cluster-97f4c386a2bec5bd0ab11c3b90ca1f7d.png" width="1913" height="587" class="img_SS3x"></p>
<p>3-nodes secured NiFi cluster:</p>
<p><img decoding="async" loading="lazy" alt="3 nodes" src="https://konpyutaika.github.io/nifikop/assets/images/3_nodes-09ddf2fa04ee827ae2632a3019ca2aab.png" width="1861" height="234" class="img_SS3x"></p>
<p>You can now update the authorizations and add additional users/groups.</p>
<div class="theme-admonition theme-admonition-note admonition_WCGJ alert alert--secondary"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_pbrs"><p>Just have a look on <a href="https://orange-opensource.github.io/nifikop/docs/3_tasks/2_security/1_ssl#operator-access-policies" target="_blank" rel="noopener noreferrer">documentation's page</a> to finish cleaning setup.
And you can now start to play with scaling, following the <a href="https://orange-opensource.github.io/nifikop/docs/3_tasks/2_security/1_ssl#scale-up---node-declaration" target="_blank" rel="noopener noreferrer">documentation's page</a></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="cleaning">Cleaning<a href="https://konpyutaika.github.io/nifikop/blog/2020-06-30-secured_nifi_cluster_on_gcp_with_external_dns#cleaning" class="hash-link" aria-label="Direct link to Cleaning" title="Direct link to Cleaning">​</a></h2>
<p>Start to remove you NiFi cluster and NiFiKop operator:</p>
<div class="language-bash codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-bash codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl delete nificlusters.nifi.orange.com nifi -n nifikop</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">helm del nifikop</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl delete crds nificlusters.nifi.orange.com</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl delete crds nifiusers.nifi.orange.com</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl delete issuers.cert-manager.io letsencrypt-staging -n nifikop</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To destroy all resources you created, you just need to run:</p>
<div class="language-consol codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-consol codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">cd terraform</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">./destroy.sh &lt;service account key's path&gt;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Alexandre Guitton</name>
            <uri>https://github.com/erdrix</uri>
        </author>
        <category label="gke" term="gke"/>
        <category label="nifikop" term="nifikop"/>
        <category label="secured" term="secured"/>
        <category label="oidc" term="oidc"/>
        <category label="google cloud platform" term="google cloud platform"/>
        <category label="google cloud" term="google cloud"/>
        <category label="gcp" term="gcp"/>
        <category label="kubernetes" term="kubernetes"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Secured NiFi cluster with NiFiKop on the Google Cloud Platform]]></title>
        <id>https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp</id>
        <link href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp"/>
        <updated>2020-05-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Credits]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_JmGV" id="credits">Credits<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#credits" class="hash-link" aria-label="Direct link to Credits" title="Direct link to Credits">​</a></h2>
<p>Before starting, I wanted to mention the fact that this post is an adaptation of the <a href="https://twitter.com/pvillard31" target="_blank" rel="noopener noreferrer">Pierre Villard</a>'s one: <a href="https://pierrevillard.com/2019/11/22/secured-nifi-cluster-with-terraform-on-the-google-cloud-platform/" target="_blank" rel="noopener noreferrer">Secured NiFi cluster with Terraform on the Google Cloud Platform</a></p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="objectives">Objectives<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#objectives" class="hash-link" aria-label="Direct link to Objectives" title="Direct link to Objectives">​</a></h2>
<p>In this article, we'll use <strong>NiFiKop</strong> and <strong>Terraform</strong> to quickly:</p>
<ul>
<li>deploy <strong>a GKE cluster</strong> to host our NiFi cluster,</li>
<li>deploy <strong>a <code>cert-manager</code> issuer</strong> as a convenient way to generate TLS certificates,</li>
<li>deploy <strong>a zookeeper instance</strong> to manage cluster coordination and state across the cluster,</li>
<li>deploy <strong>X secured NiFi instances in cluster mode</strong></li>
<li>configure <strong>NiFi to use OpenId connect</strong> for authentication</li>
<li>configure <strong>HTTPS loadbalancer with Client Ip affinity</strong> to access to the NiFi cluster</li>
<li>re-size the cluster dynamically</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="pre-requisites">Pre-requisites<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#pre-requisites" class="hash-link" aria-label="Direct link to Pre-requisites" title="Direct link to Pre-requisites">​</a></h2>
<ul>
<li>You have your own domain (<a href="https://domains.google/" target="_blank" rel="noopener noreferrer">you can create on with Google</a>): it will be used to map a domain to the NiFi's web interface. In this post, we will use: <code>trycatchlearn.fr</code>.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="disclaimer">Disclaimer<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#disclaimer" class="hash-link" aria-label="Direct link to Disclaimer" title="Direct link to Disclaimer">​</a></h3>
<p>This article can get you started for a production deployment, but should not used as so. There is still some steps needed such as Zookeeper configuration etc.</p>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="create-oauth-credentials">Create OAuth Credentials<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#create-oauth-credentials" class="hash-link" aria-label="Direct link to Create OAuth Credentials" title="Direct link to Create OAuth Credentials">​</a></h3>
<p>First step is to create the OAuth Credential:</p>
<ul>
<li>Go to your GCP project, and in the left bar: <strong>APIs &amp; Services &gt; Credentials</strong></li>
<li>Click on <code>CREATE CREDENTIALS: OAuth client ID</code></li>
<li>Select <code>Web Application</code></li>
<li>Give a name like <code>SecuredNifi</code>.</li>
<li>For <code>Authorised JavaScript origins</code>, use your own domain. I'm using: <code>https://nifisecured.trycatchlearn.fr:8443</code></li>
<li>For <code>Authorised redirect URIs</code> it's your previous URI + <code>/nifi-api/access/oidc/callback</code>, for me: <code>https://nifisecured.trycatchlearn.fr:8443/nifi-api/access/oidc/callback</code></li>
</ul>
<p><img decoding="async" loading="lazy" alt="OAuth credentials" src="https://konpyutaika.github.io/nifikop/assets/images/oauth_credentials-5fc8292d57455fd7b0703ed869fc31a6.png" width="616" height="937" class="img_SS3x"></p>
<ul>
<li>Create the OAuth credentials</li>
</ul>
<p>Once the credentials are created, you will get a client ID and a client secret that you will need in <code>NifiCluster</code> definition.</p>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="create-service-account">Create service account<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#create-service-account" class="hash-link" aria-label="Direct link to Create service account" title="Direct link to Create service account">​</a></h3>
<p>For the GKE cluster deployment you need a service account with <code>Editor</code> role, and <code>Kubernetes Engine Admin</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-secured-cluster">Deploy secured cluster<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#deploy-secured-cluster" class="hash-link" aria-label="Direct link to Deploy secured cluster" title="Direct link to Deploy secured cluster">​</a></h2>
<p>Once you have completed the above prerequisites, deploying you NiFi cluster will only take three steps and few minutes.</p>
<p>Open your Google Cloud Console in your GCP project and run:</p>
<div class="language-sh codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sh codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">git clone https://github.com/konpyutaika/nifikop/nifikop.git</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cd nifikop/docs/tutorials/secured_nifi_cluster_on_gcp</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-gke-cluster-with-terraform">Deploy GKE cluster with Terraform<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#deploy-gke-cluster-with-terraform" class="hash-link" aria-label="Direct link to Deploy GKE cluster with Terraform" title="Direct link to Deploy GKE cluster with Terraform">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_JmGV" id="deployment">Deployment<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">​</a></h4>
<p>You can configure variable before running the deployment in the file <code>terraform/env/demo.tfvars</code>:</p>
<ul>
<li><strong>project</strong>: GCP project ID</li>
<li><strong>region</strong>: GCP region</li>
<li><strong>zone</strong>: GCP zone</li>
<li><strong>cluster_machines_types</strong>: defines the machine type for GKE cluster nodes</li>
<li><strong>min_node</strong>: minimum number of nodes in the NodePool. Must be &gt;=0 and &lt;= max_node_count.</li>
<li><strong>max_node</strong>: maximum number of nodes in the NodePool. Must be &gt;= min_node_count.</li>
<li><strong>initial_node_count</strong>: the number of nodes to create in this cluster's default node pool.</li>
<li><strong>preemptible</strong>: true/false using preemptibles nodes.</li>
<li><strong>nifikop_image_repo</strong>: NiFiKop's image repository</li>
<li><strong>nifikop_image_tag</strong>: NiFiKop's image tag</li>
<li><strong>nifikop_chart_version</strong>: NiFiKop's helm chart version</li>
</ul>
<div class="language-sh codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-sh codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">./start.sh &lt;service account key's path&gt;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This operation could take 15 minutes (time to the GKE cluster and its nodes to setup)</p>
<p>Once the deployment is ready load the GKE configuration:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">gcloud container clusters get-credentials nifi-cluster --zone &lt;configured gcp zone&gt; --project &lt;GCP project's id&gt;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_JmGV" id="explanations">Explanations<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#explanations" class="hash-link" aria-label="Direct link to Explanations" title="Direct link to Explanations">​</a></h4>
<p>The first step is to deploy a GKE cluster, with the required configuration, you can for example check the nodes configuration:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get nodes</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                                                  STATUS   ROLES    AGE    VERSION</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-2dl3   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-5bzb   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-5t3l   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">gke-nifi-cluster-tracking-ptf20200520-a1aec8fe-w86j   Ready    &lt;none&gt;   110m   v1.15.9-gke.24</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once the cluster is deployed, we created all the required namespaces:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get namespaces</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME              STATUS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager      Active   106m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">default           Active   116m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kube-node-lease   Active   116m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kube-public       Active   116m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kube-system       Active   116m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifi              Active   106m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper         Active   106m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the <code>cert-manager</code> namespace we deployed a <code>cert-manager</code> stack in a cluster-wide scope, which will be responsible for all the certificates generation.</p>
<div class="theme-admonition theme-admonition-note admonition_WCGJ alert alert--secondary"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_pbrs"><p>in this post, we will let <code>cert-manager</code> create a self-signed CA.
For more information check <a href="https://konpyutaika.github.io/nifikop/docs/3_tasks/2_security/1_ssl" target="_blank" rel="noopener noreferrer">documentation page</a></p></div></div>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl -n cert-manager get pods</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                                       READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager-55fff7f85f-74nf5              1/1     Running   0          72m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager-cainjector-54c4796c5d-mfbbx   1/1     Running   0          72m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">cert-manager-webhook-77ccf5c8b4-m6ws4      1/1     Running   2          72m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It will also deploy the Zookeeper cluster based on the <a href="https://github.com/bitnami/charts/tree/master/bitnami/zookeeper" target="_blank" rel="noopener noreferrer">bitnami helm chart</a>:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl -n zookeeper get pods</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME          READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper-0   1/1     Running   0          74m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper-1   1/1     Running   0          74m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">zookeeper-2   1/1     Running   0          74m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And finally it deploy the <code>NiFiKop</code> operator which is ready to create NiFi clusters:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl -n nifi get pods</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME          READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifikop-849fc8548f-ss6w4   1/1     Running   0          74m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="deploy-secured-nifi-cluster">Deploy Secured NiFi cluster<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#deploy-secured-nifi-cluster" class="hash-link" aria-label="Direct link to Deploy Secured NiFi cluster" title="Direct link to Deploy Secured NiFi cluster">​</a></h3>
<p>You will now deploy your secured cluster to do so edit the <code>kubernetes/nifi/secured_nifi_cluster.yaml</code> and set with your own values:</p>
<div class="language-yaml codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-yaml codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token key atrule" style="color:#859900">apiVersion</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> nifi.orange.com/v1alpha1</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">kind</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> NifiCluster</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">metadata</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">name</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> securednificluster</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">namespace</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> nifi</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain"></span><span class="token key atrule" style="color:#859900">spec</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token punctuation" style="color:#657b83">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">initialAdminUser</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> &lt;your google account email</span><span class="token punctuation" style="color:#657b83">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">  </span><span class="token key atrule" style="color:#859900">readOnlyConfig</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token comment" style="color:#93a1a1"># NifiProperties configuration that will be applied to the node.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">    </span><span class="token key atrule" style="color:#859900">nifiProperties</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">webProxyHosts</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">        </span><span class="token punctuation" style="color:#657b83">-</span><span class="token plain"> &lt;nifi's hostname</span><span class="token punctuation" style="color:#657b83">&gt;</span><span class="token punctuation" style="color:#657b83">:</span><span class="token number" style="color:#5a9bcf">8443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token comment" style="color:#93a1a1"># Additionnal nifi.properties configuration that will override the one produced based</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token comment" style="color:#93a1a1"># on template and configurations.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">      </span><span class="token key atrule" style="color:#859900">overrideConfigs</span><span class="token punctuation" style="color:#657b83">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#657b83">|</span><span class="token scalar string" style="color:#8dc891"></span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        ...</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        nifi.security.user.oidc.client.id=&lt;oidc client's id&gt;</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        nifi.security.user.oidc.client.secret=&lt;oidc client's secret&gt;</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token scalar string" style="color:#8dc891">        ...</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><strong>Spec.InitialAdminUser</strong>: Your GCP account email (this will give you the admin role into the NiFi cluster), in my case <code>aguitton.ext@orange.com</code></li>
<li><strong>Spec.ReadOnlyConfig.NifiProperties.WebProxyHosts[0]</strong>: The web hostname configured in the Oauth section, in my case <code>nifisecured.trycatchlearn.fr</code></li>
<li><strong>Spec.ReadOnlyConfig.NifiProperties.OverrideConfigs</strong>: you have to set the following properties:<!-- -->
<ul>
<li><em>nifi.security.user.oidc.client.id</em>: OAuth Client ID</li>
<li><em>nifi.security.user.oidc.client.secret</em>: OAuth Client secret</li>
</ul>
</li>
</ul>
<p>Once the configuration is ok, you can deploy the <code>NifiCluster</code>:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl create -f kubernetes/nifi/secured_nifi_cluster.yaml</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After 5 minutes your cluster should be running:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl get pods -n nifi</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                             READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">nifikop-849fc8548f-ss6w4         1/1     Running   0          28h</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">securednificluster-0-node9tqff   1/1     Running   0          5m52s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">securednificluster-1-nodew9tsd   1/1     Running   0          6m30s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">securednificluster-2-nodemlxs8   1/1     Running   0          6m28s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">securednificluster-3-nodeckw8p   1/1     Running   0          6m26s</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">securednificluster-4-nodewzjt7   1/1     Running   0          6m24s</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_JmGV" id="access-to-your-secured-nifi-cluster">Access to your secured NiFi Cluster<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#access-to-your-secured-nifi-cluster" class="hash-link" aria-label="Direct link to Access to your secured NiFi Cluster" title="Direct link to Access to your secured NiFi Cluster">​</a></h3>
<p>To finish you have to get the public IP of the load balancer:</p>
<div class="language-console codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-console codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl -n nifi get svc</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">NAME                          TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                                         AGE</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">securednificluster            LoadBalancer   10.15.248.159   34.78.140.135   8443:30248/TCP,6007:30517/TCP,10000:31985/TCP   27m</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">securednificluster-headless   ClusterIP      None            &lt;none&gt;          8443/TCP,6007/TCP,10000/TCP                     27m</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In my case it's <code>34.78.140.135</code>.</p>
<p>We can now update the DNS records of your domains to add a DNS record of type A redirecting your hostname (in my case <code>nifisecured.trycatchlearn.fr</code>) to the load balancer IP.</p>
<p>I can now access the NiFi cluster using <a href="https://nifisecured.trycatchlearn.fr:8443/nifi" target="_blank" rel="noopener noreferrer">https://nifisecured.trycatchlearn.fr:8443/nifi</a> and authenticate on the cluster using the admin account email address I configured in the <code>NifiCluster</code> resource.</p>
<p>Here is my 5-nodes secured NiFi cluster up and running:</p>
<p><img decoding="async" loading="lazy" alt="6 nodes cluster" src="https://konpyutaika.github.io/nifikop/assets/images/6_nodes_cluster-a7a447412b980b89f1b0c8311eb3c08a.png" width="1919" height="714" class="img_SS3x"></p>
<p>5-nodes secured NiFi cluster:</p>
<p><img decoding="async" loading="lazy" alt="5 nodes" src="https://konpyutaika.github.io/nifikop/assets/images/5_nodes-13c70eaa843b818938eb16931dfc5a34.png" width="1860" height="335" class="img_SS3x"></p>
<p>You can now update the authorizations and add additionnal users/groups.</p>
<div class="theme-admonition theme-admonition-note admonition_WCGJ alert alert--secondary"><div class="admonitionHeading_GCBg"><span class="admonitionIcon_L39b"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_pbrs"><p>Just have a look on <a href="https://konpyutaika.github.io/nifikop/docs/3_tasks/2_security/1_ssl#operator-access-policies" target="_blank" rel="noopener noreferrer">documentation's page</a> to finish cleaning setup.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_JmGV" id="cleaning">Cleaning<a href="https://konpyutaika.github.io/nifikop/blog/secured_nifi_cluster_on_gcp#cleaning" class="hash-link" aria-label="Direct link to Cleaning" title="Direct link to Cleaning">​</a></h2>
<p>To destroy all resources you created, you just need to run:</p>
<div class="language-consol codeBlockContainer_mQmQ theme-code-block" style="--prism-color:#FFFFFF;--prism-background-color:#282C34"><div class="codeBlockContent_D5yF"><pre tabindex="0" class="prism-code language-consol codeBlock_RMoD thin-scrollbar" style="color:#FFFFFF;background-color:#282C34"><code class="codeBlockLines_AclH"><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl delete nificlusters.nifi.orange.com securednificluster -n nifi</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl delete crds nificlusters.nifi.orange.com</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">kubectl delete crds nifiusers.nifi.orange.com</span><br></span><span class="token-line" style="color:#FFFFFF"><span class="token plain">./destroy.sh &lt;service account key's path&gt;</span><br></span></code></pre><div class="buttonGroup_aaMX"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_z5j7" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_FoOz"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_L0B6"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Alexandre Guitton</name>
            <uri>https://github.com/erdrix</uri>
        </author>
        <category label="gke" term="gke"/>
        <category label="nifikop" term="nifikop"/>
        <category label="secured" term="secured"/>
        <category label="oidc" term="oidc"/>
        <category label="google cloud platform" term="google cloud platform"/>
        <category label="google cloud" term="google cloud"/>
        <category label="gcp" term="gcp"/>
        <category label="kubernetes" term="kubernetes"/>
    </entry>
</feed>